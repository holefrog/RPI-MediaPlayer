#!/bin/bash
# bluetooth-a2dp-autopair.sh - æ ‘è“æ´¾ A2DP è“ç‰™éŸ³ç®±è‡ªåŠ¨é…å¯¹æœåŠ¡
# ç”Ÿæˆè‡ª: templates/scripts/bluetooth-a2dp-autopair.sh.template
# ä¿®å¤ç‰ˆï¼šä½¿ç”¨é…ç½®åŒ–è¶…æ—¶å‚æ•°

set -euo pipefail

# ============================================
# é…ç½®å‚æ•°
# ============================================
BT_NAME="{{BT_NAME}}"
USER_NAME="{{USER_NAME}}"
PINS_FILE="{{PINS_FILE}}"
USER_RUNTIME_DIR="{{USER_RUNTIME_DIR}}"
CHECK_INTERVAL={{CHECK_INTERVAL}}

# ğŸ†• é…ç½®åŒ–è¶…æ—¶å‚æ•°
BT_INIT_DELAY={{BT_INIT_DELAY}}
BT_RFKILL_DELAY={{BT_RFKILL_DELAY}}

# ============================================
# ç»Ÿä¸€æ—¥å¿—å‡½æ•°
# ============================================
log() {
    echo "[$(date '+%H:%M:%S')] [BT-AutoPair] [INFO] $*"
}

warn() {
    echo "[$(date '+%H:%M:%S')] [BT-AutoPair] [WARN] $*" >&2
}

error() {
    echo "[$(date '+%H:%M:%S')] [BT-AutoPair] [ERROR] $*" >&2
}

# ============================================
# è¾…åŠ©å‡½æ•°ï¼šä»¥æ­£ç¡®ç”¨æˆ·èº«ä»½è¿è¡Œ pactl
# ============================================
run_pactl() {
    sudo -u "$USER_NAME" XDG_RUNTIME_DIR="$USER_RUNTIME_DIR" pactl "$@"
}

# ============================================
# åˆå§‹åŒ–è“ç‰™
# ============================================
initialize_bluetooth() {
    log "ğŸ”„ åˆå§‹åŒ–è“ç‰™ç”¨äº A2DP"
    
    # è§£é”è“ç‰™ (éœ€è¦ root æƒé™)
    sudo rfkill unblock bluetooth
    
    # ğŸ†• ä½¿ç”¨é…ç½®åŒ–å»¶è¿Ÿ
    sleep "$BT_RFKILL_DELAY"
    
    # é…ç½®è“ç‰™
    bluetoothctl power on
    bluetoothctl system-alias "$BT_NAME"
    bluetoothctl discoverable on
    bluetoothctl pairable on
    bluetoothctl discoverable-timeout 0
    
    if [ "$?" -ne 0 ]; then
        error "âŒ è“ç‰™åˆå§‹åŒ–å¤±è´¥"
        return 1
    fi
    
    log "ğŸ“¡ åˆå§‹åŒ–å®Œæˆ"
    bluetoothctl show | \
        grep -E 'Powered|Discoverable|Pairable' | \
        sed 's/^/    /' | \
        while read -r line; do
            log "$line"
        done
    
    # ç¡®ä¿ PipeWire è“ç‰™æ¨¡å—åŠ è½½
    run_pactl load-module module-bluez5-device 2>/dev/null || \
        warn "âš ï¸ è“ç‰™éŸ³é¢‘æ¨¡å—å·²åŠ è½½æˆ–åŠ è½½å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰"
    
    return 0
}

# ============================================
# æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„è“ç‰™éŸ³é¢‘è¿æ¥
# ============================================
has_active_connection() {
    if run_pactl list sinks short | grep -q "bluez_sink"; then
        local sink_name
        sink_name=$(run_pactl list sinks short | grep bluez_sink | awk '{print $2}' | head -1)
        
        # è®¾ç½®ä¸ºé»˜è®¤è¾“å‡º
        run_pactl set-default-sink "$sink_name" 2>/dev/null || true
        
        log "ğŸ”Š è“ç‰™è®¾å¤‡å·²è¿æ¥: $sink_name"
        return 0
    fi
    
    return 1
}

# ============================================
# ä¸»å‡½æ•°
# ============================================
main() {
    log "=========================================="
    log "ğŸš€ è“ç‰™ A2DP è‡ªåŠ¨é…å¯¹æœåŠ¡å¯åŠ¨"
    log "=========================================="
    log "è®¾å¤‡åç§°: $BT_NAME"
    log "è¿è¡Œç”¨æˆ·: $USER_NAME"
    log "PIN æ–‡ä»¶: $PINS_FILE"
    log "æ£€æŸ¥é—´éš”: ${CHECK_INTERVAL}ç§’"
    log "åˆå§‹åŒ–å»¶è¿Ÿ: ${BT_INIT_DELAY}ç§’"
    log "Rfkill å»¶è¿Ÿ: ${BT_RFKILL_DELAY}ç§’"
    log ""
    
    # åˆå§‹åŒ–è“ç‰™
    initialize_bluetooth || {
        error "âŒ è“ç‰™åˆå§‹åŒ–å¤±è´¥ï¼Œ5ç§’åé‡è¯•..."
        sleep 5
        exit 1
    }
    
    # å¯åŠ¨ bt-agent
    log "ğŸ”„ å¯åŠ¨ bt-agent ä»£ç†ï¼ˆNoInputNoOutput æ¨¡å¼ï¼‰"
    bt-agent -c NoInputNoOutput -p "$PINS_FILE" &
    AGENT_PID=$!
    log "âœ“ bt-agent å·²å¯åŠ¨ (PID: $AGENT_PID)"
    
    # ä¸»å¾ªç¯
    log "ğŸ” è¿›å…¥ç›‘æ§å¾ªç¯..."
    log ""
    
    CHECK_COUNT=0
    
    while true; do
        # ç¡®ä¿è“ç‰™æœªè¢«é˜»æ­¢
        sudo rfkill unblock bluetooth 2>/dev/null || true
        
        # ğŸ†• ä½¿ç”¨é…ç½®åŒ–å»¶è¿Ÿ
        sleep "$BT_RFKILL_DELAY"
        
        # æ£€æŸ¥ bt-agent æ˜¯å¦è¿˜åœ¨è¿è¡Œ
        if ! ps -p "$AGENT_PID" > /dev/null 2>&1; then
            warn "âš ï¸ bt-agent è¿›ç¨‹å·²é€€å‡ºï¼Œé‡æ–°å¯åŠ¨"
            bt-agent -c NoInputNoOutput -p "$PINS_FILE" &
            AGENT_PID=$!
            log "âœ“ bt-agent å·²é‡å¯ (PID: $AGENT_PID)"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒè¿æ¥
        if has_active_connection; then
            log "ğŸ”µ å·²æœ‰è“ç‰™è®¾å¤‡è¿æ¥ï¼Œå…³é—­é…å¯¹æ¨¡å¼"
            bluetoothctl discoverable off 2>/dev/null || true
        else
            log "âšª æ— æ´»è·ƒè¿æ¥ï¼Œå¯ç”¨é…å¯¹æ¨¡å¼"
            bluetoothctl discoverable on 2>/dev/null || true
            bluetoothctl pairable on 2>/dev/null || true
            bluetoothctl discoverable-timeout 0 2>/dev/null || true
            
            # å°è¯•é‡æ–°åŠ è½½è“ç‰™æ¨¡å—
            run_pactl load-module module-bluez5-device 2>/dev/null || true
        fi
        
        # è¾“å‡ºå½“å‰çŠ¶æ€ï¼ˆæ¯ 5 ä¸ªå‘¨æœŸä¸€æ¬¡è¯¦ç»†è¾“å‡ºï¼‰
        CHECK_COUNT=$((CHECK_COUNT + 1))
        if [ $((CHECK_COUNT % 5)) -eq 0 ]; then
            log "ğŸ“¡ çŠ¶æ€æ£€æŸ¥ #$CHECK_COUNT"
            bluetoothctl show | \
                grep -E 'Powered|Discoverable|Pairable' | \
                sed 's/^/    /' | \
                while read -r line; do
                    log " $line"
                done
        fi
        
        # ç­‰å¾…ä¸‹ä¸€æ¬¡æ£€æŸ¥
        sleep "$CHECK_INTERVAL"
    done
}

# ============================================
# ä¿¡å·å¤„ç†ï¼ˆä¼˜é›…é€€å‡ºï¼‰
# ============================================
cleanup() {
    log ""
    log "ğŸ›‘ æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œæ­£åœ¨æ¸…ç†..."
    
    # åœæ­¢ bt-agent
    if [ -n "${AGENT_PID:-}" ] && ps -p "$AGENT_PID" > /dev/null 2>&1; then
        log "åœæ­¢ bt-agent (PID: $AGENT_PID)"
        kill "$AGENT_PID" 2>/dev/null || true
    fi
    
    log "âœ“ æ¸…ç†å®Œæˆï¼ŒæœåŠ¡é€€å‡º"
    exit 0
}

trap cleanup SIGTERM SIGINT

# ============================================
# å¯åŠ¨ä¸»å‡½æ•°
# ============================================
main
